<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple Uni V2 Tree (Part 2) &mdash; DeFiPy  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Price Agent" href="../onchain/price_threshold_swap.html" />
    <link rel="prev" title="Simple Uni V2 Tree (Part 1)" href="simple_tree_pt1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #673147" >
            <a href="../index.html">
            <img src="../_static/defipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Licensing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DeFi Math</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../math/univ2_math.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/univ3_math.html">Uniswap V3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../uniswapv2/index.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uniswapv3/index.html">Uniswap V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../balancer/index.html">Balancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stableswap/index.html">Stableswap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analytics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="univ2_sim.html">Uniswap V2 Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="order_book.html">Uniswap V3 Order Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="imp_loss.html">Impermanent Loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="fsm.html">Finite State Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="simple_tree_pt1.html">Simple Uni V2 Tree (Part 1)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Simple Uni V2 Tree (Part 2)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#üìò-Notable-Classes">üìò Notable Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Script-params">Script params</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Simulate-price-data">Simulate price data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Initialization-Params">Initialization Params</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Initialize-DEX-Tree">Initialize DEX Tree</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Take-an-investment-position">Take an investment position</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Simulate-trading">Simulate trading</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Onchain</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../onchain/price_threshold_swap.html">Price Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onchain/tvl_based_liquidity.html">Liquidity Exit Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onchain/volume_spike_notifier.html">Volume Spike Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onchain/pool_events.html">Pool Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onchain/testnet_sim_univ2.html">Solidity Script Interfacing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Abstract API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../abstract_uniswap.html">Uniswap V2/V3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Primitive API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../primitive_uniswapv2.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_uniswapv3.html">Uniswap V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_balancer.html">Balancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_stableswap.html">StableSwap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #673147" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DeFiPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Simple Uni V2 Tree (Part 2)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/simple_tree_pt2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Simple-Uni-V2-Tree-(Part-2)">
<h1>Simple Uni V2 Tree (Part 2)<a class="headerlink" href="#Simple-Uni-V2-Tree-(Part-2)" title="Permalink to this heading">ÔÉÅ</a></h1>
<ul class="simple">
<li><p>Assumptions:</p>
<ul>
<li><p>Uses Simple Tree</p></li>
<li><p>Uses stablecoins (ie, USDC and USDT) to control for impermanent loss</p></li>
<li><p>Includes state machine to handle finite supply of index tokens</p></li>
</ul>
</li>
<li><p>LPs include:</p>
<ul>
<li><p>USDC-USDT</p></li>
<li><p>USDC-iUSDC</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://medium.com/&#64;icmoore/liquidity-tree-performance-using-stablecoins-part-2-41b0c7446403">Medium Article: Liquidity Tree Performance using Stablecoins: Part 2</a></p></li>
<li><p>To download notebook to this tutorial, see <a class="reference external" href="https://github.com/defipy-devs/uniswappy/blob/main/notebooks/medium_articles/simple_tree_pt2.ipynb">here</a></p></li>
</ul>
<section id="üìò-Notable-Classes">
<h2>üìò Notable Classes<a class="headerlink" href="#üìò-Notable-Classes" title="Permalink to this heading">ÔÉÅ</a></h2>
<hr class="docutils" />
<ul class="simple">
<li><p><strong>Class</strong>: üìò <code class="docutils literal notranslate"><span class="pre">defipy.math.model.BrownianModel</span></code></p>
<ul>
<li><p><strong>Purpose</strong>: Geometric Brownian process.</p></li>
<li><p><strong>Methods</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">gen_gbms(mu:</span> <span class="pre">float,</span> <span class="pre">sigma:</span> <span class="pre">float,</span> <span class="pre">n_step:</span> <span class="pre">int,</span> <span class="pre">T:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1)</span></code></p>
<ul>
<li><p><strong>Parameters</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mu</span></code>: asset drift (<code class="docutils literal notranslate"><span class="pre">float</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma</span></code>: asset volatility (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_step</span></code>: number of steps. (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T</span></code>: time unit (optional) (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Class</strong>: üìò <code class="docutils literal notranslate"><span class="pre">defipy.math.model.TokenDeltaModel</span></code></p>
<ul>
<li><p><strong>Purpose</strong>: Random sample of Gamma distribution representing an experimental token amount.</p></li>
<li><p><strong>Methods</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">delta(p:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">1)</span></code></p>
<ul>
<li><p><strong>Parameters</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">p</span></code>: buy/sell probability associated (buy = 1, sell = -1, optional) (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Class</strong>: üìò <code class="docutils literal notranslate"><span class="pre">defipy.analytics.simulate.CorrectReserves</span></code></p>
<ul>
<li><p><strong>Purpose</strong>: Applies <code class="docutils literal notranslate"><span class="pre">SolveDeltas</span></code> to Correct x/y reserve amounts so that price reflects desired input price; in the marjority of cases, the input price would be the most recent outside market price .</p></li>
<li><p><strong>Methods</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">delta(price:</span> <span class="pre">float,</span> <span class="pre">lwr_tick:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">None,</span> <span class="pre">upr_tick:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">None)</span></code></p>
<ul>
<li><p><strong>Parameters</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">price</span></code>: token price (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lwr_tick</span></code>: Lower tick of the position. (optional) (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upr_tick</span></code>: Upper tick of the position. (optional) (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">defipy</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</section>
<section id="Script-params">
<h2>Script params<a class="headerlink" href="#Script-params" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_tkn_lp</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">tkn_delta_param</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">tkn_invest_amt</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">tkn_nm</span> <span class="o">=</span> <span class="s1">&#39;USDC&#39;</span>
<span class="n">itkn_nm</span> <span class="o">=</span> <span class="s1">&#39;iUSDC&#39;</span>
<span class="n">usd_nm</span> <span class="o">=</span> <span class="s1">&#39;USDT&#39;</span>
<span class="n">iusd_nm</span> <span class="o">=</span> <span class="s1">&#39;iUSDT&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="Simulate-price-data">
<h2>Simulate price data<a class="headerlink" href="#Simulate-price-data" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># *************************</span>
<span class="c1"># *** Simulation</span>
<span class="c1"># *************************</span>
<span class="n">n_sim_runs</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">seconds_year</span> <span class="o">=</span> <span class="mi">31536000</span>
<span class="n">shape</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mf">0.0005</span>

<span class="n">p_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">n_sim_runs</span><span class="p">)</span>

<span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_arr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds_year</span><span class="o">/</span><span class="n">n_sim_runs</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2024-09-01&quot;</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">dt</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="p">)]</span>

<span class="n">x_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">p_arr</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">USD_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">p_arr</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial invest&#39;</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price Chart (</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">usd_nm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (USD)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;Date&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_simple_tree_pt2_6_1.png" src="../_images/tutorials_simple_tree_pt2_6_1.png" />
</div>
</div>
</section>
<section id="Initialization-Params">
<h2>Initialization Params<a class="headerlink" href="#Initialization-Params" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_nm</span> <span class="o">=</span> <span class="s1">&#39;user0&#39;</span>
<span class="n">tkn_amount</span> <span class="o">=</span> <span class="n">init_tkn_lp</span>
<span class="n">dai_amount</span> <span class="o">=</span> <span class="n">p_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">tkn_amount</span>
</pre></div>
</div>
</div>
</section>
<section id="Initialize-DEX-Tree">
<h2>Initialize DEX Tree<a class="headerlink" href="#Initialize-DEX-Tree" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dai1</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">usd_nm</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">tkn1</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">tkn_nm</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">dai1</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">TKN_amt</span> <span class="o">=</span> <span class="n">TokenDeltaModel</span><span class="p">(</span><span class="n">tkn_delta_param</span><span class="p">)</span>
<span class="n">TKN_amt_arb</span> <span class="o">=</span> <span class="n">TokenDeltaModel</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">lp1_state</span> <span class="o">=</span> <span class="n">MarkovState</span><span class="p">(</span><span class="n">stochastic</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">iVault1</span> <span class="o">=</span> <span class="n">IndexVault</span><span class="p">(</span><span class="s1">&#39;iVault1&#39;</span><span class="p">,</span> <span class="s2">&quot;0x7&quot;</span><span class="p">)</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s2"> pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">Join</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">tkn_amount</span><span class="p">,</span> <span class="n">dai_amount</span><span class="p">)</span>

<span class="n">tkn2</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">tkn_nm</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">itkn1</span> <span class="o">=</span> <span class="n">IndexERC20</span><span class="p">(</span><span class="n">itkn_nm</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp</span><span class="p">)</span>
<span class="n">exchg_data1</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">tkn2</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP1&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x012&quot;</span><span class="p">)</span>
<span class="n">lp1</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data1</span><span class="p">)</span>
<span class="n">JoinTree</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">iVault1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Re-balance LP price after JoinTree</span>
<span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">dai1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">tkn1</span><span class="p">)</span> <span class="o">-</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">dai1</span><span class="p">))</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">lp1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 110000.0, USDT = 110000.0
Liquidity: 109983.66359843774

Exchange USDC-iUSDC (LP1)
Reserves: USDC = 9972.071706380653, iUSDC = 4843.944835233285
Liquidity: 6950.119800312692

</pre></div></div>
</div>
<section id="Take-an-investment-position">
<h3>Take an investment position<a class="headerlink" href="#Take-an-investment-position" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tkn_invest</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">invested_user_nm</span> <span class="o">=</span> <span class="s1">&#39;invested_user&#39;</span>

<span class="n">SwapIndexMint</span><span class="p">(</span><span class="n">iVault1</span><span class="p">,</span> <span class="n">opposing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">invested_user_nm</span><span class="p">,</span> <span class="n">tkn_invest</span><span class="p">)</span>
<span class="n">mint_itkn1_deposit</span> <span class="o">=</span> <span class="n">lp1</span><span class="o">.</span><span class="n">convert_to_human</span><span class="p">(</span><span class="n">iVault1</span><span class="o">.</span><span class="n">index_tokens</span><span class="p">[</span><span class="n">itkn_nm</span><span class="p">][</span><span class="s1">&#39;last_lp_deposit&#39;</span><span class="p">])</span>
<span class="n">lp1_state</span><span class="o">.</span><span class="n">next_state</span><span class="p">(</span><span class="n">mint_itkn1_deposit</span><span class="p">)</span>
<span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">invested_user_nm</span><span class="p">,</span> <span class="n">mint_itkn1_deposit</span><span class="p">)</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">lp1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">lp_invest_track</span>  <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_liquidity_from_provider</span><span class="p">(</span><span class="n">invested_user_nm</span><span class="p">)</span>
<span class="n">lp1_invest_track</span>  <span class="o">=</span> <span class="n">lp1</span><span class="o">.</span><span class="n">get_liquidity_from_provider</span><span class="p">(</span><span class="n">invested_user_nm</span><span class="p">)</span>

<span class="c1"># Redeem from parent</span>
<span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>

<span class="c1"># Redeem from tree (child + parent)</span>
<span class="n">itkn_redeem_child</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">lp1_invest_track</span><span class="p">)</span>
<span class="n">tkn_redeem_tree</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">itkn_redeem_child</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_parent</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP tokens if </span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC immediately pulled from parent&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_tree</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp1_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP1 tokens if </span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC immediately pulled from tree&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 110100.0, USDT = 110000.0
Liquidity: 110033.56973158607

Exchange USDC-iUSDC (LP1)
Reserves: USDC = 9972.071706380653, iUSDC = 4893.850968381618
Liquidity: 6985.777211181214

99.700 USDC redeemed from 49.906 LP tokens if 100.0 invested USDC immediately pulled from parent
99.403 USDC redeemed from 35.657 LP1 tokens if 100.0 invested USDC immediately pulled from tree
</pre></div></div>
</div>
</section>
<section id="Simulate-trading">
<h3>Simulate trading<a class="headerlink" href="#Simulate-trading" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arb</span> <span class="o">=</span> <span class="n">CorrectReserves</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">arb1</span> <span class="o">=</span> <span class="n">Arbitrage</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">lp1_state</span><span class="p">)</span>

<span class="n">TKN_amt</span> <span class="o">=</span> <span class="n">TokenDeltaModel</span><span class="p">(</span><span class="n">tkn_delta_param</span><span class="p">)</span>

<span class="n">lp_direct_invest_arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lp1_direct_invest_arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lp1_tree_invest_arr</span> <span class="o">=</span> <span class="p">[];</span>
<span class="n">pTKN_DAI_arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">pTKN_iTKN_arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fee_lp_arr</span>  <span class="o">=</span> <span class="p">[];</span> <span class="n">fee_lp1_arr</span>  <span class="o">=</span> <span class="p">[];</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="p">):</span>

    <span class="c1">#if(k % 100 == 0 and k != 0): print(f&#39;Processing event {k}&#39;)</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># ***** Parent Arbitrage ******</span>
    <span class="c1"># *****************************</span>
    <span class="n">arb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">p_arr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># ***** Child Arbitrage ******</span>
    <span class="c1"># *****************************</span>
    <span class="n">amt_arb1</span> <span class="o">=</span> <span class="n">TKN_amt_arb</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span>
    <span class="n">arb1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">amt_arb1</span><span class="p">)</span>
    <span class="n">arb1</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">itkn1</span><span class="p">)</span>

    <span class="n">mint_tkn1_amt</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">TKN_amt</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span>
    <span class="n">SwapIndexMint</span><span class="p">(</span><span class="n">iVault1</span><span class="p">,</span> <span class="n">opposing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">mint_tkn1_amt</span><span class="p">)</span>
    <span class="n">mint_itkn1_deposit</span> <span class="o">=</span> <span class="n">lp1</span><span class="o">.</span><span class="n">convert_to_human</span><span class="p">(</span><span class="n">iVault1</span><span class="o">.</span><span class="n">index_tokens</span><span class="p">[</span><span class="n">itkn_nm</span><span class="p">][</span><span class="s1">&#39;last_lp_deposit&#39;</span><span class="p">])</span>
    <span class="n">lp1_state</span><span class="o">.</span><span class="n">next_state</span><span class="p">(</span><span class="n">mint_itkn1_deposit</span><span class="p">)</span>
    <span class="n">vault_lp1_amt</span> <span class="o">=</span> <span class="n">lp1_state</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">(</span><span class="s1">&#39;dVault&#39;</span><span class="p">)</span>
    <span class="n">burned_itkn1_amt</span> <span class="o">=</span> <span class="n">lp1_state</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">(</span><span class="s1">&#39;dBurned&#39;</span><span class="p">)</span>

    <span class="c1">## WithdrawSwap burned token from parent LP</span>
    <span class="k">if</span><span class="p">(</span><span class="n">burned_itkn1_amt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">total_tkn_w_swap</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">burned_itkn1_amt</span><span class="p">)</span>
        <span class="n">amt_out</span> <span class="o">=</span> <span class="n">RemoveLiquidity</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">total_tkn_w_swap</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">## Balance LP1: TKN/iTKN</span>
    <span class="k">if</span><span class="p">(</span><span class="n">vault_lp1_amt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># A portion of aquired token is coming from newly minted, while the remainder is coming from held</span>
        <span class="n">amt_tkn</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">vault_lp1_amt</span><span class="p">)</span>
        <span class="n">price_tkn</span> <span class="o">=</span> <span class="n">amt_tkn</span><span class="o">/</span><span class="n">vault_lp1_amt</span>
        <span class="n">AddLiquidity</span><span class="p">(</span><span class="n">price_tkn</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">vault_lp1_amt</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">vault_lp1_amt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># A portion of removed token is getting held, while the remainder is getting burned</span>
        <span class="n">RemoveLiquidity</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vault_lp1_amt</span><span class="p">))</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># ***** Random Swapping ******</span>
    <span class="c1"># *****************************</span>
    <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">TKN_amt</span><span class="o">.</span><span class="n">delta</span><span class="p">())</span>
    <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">dai1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">TKN_amt</span><span class="o">.</span><span class="n">delta</span><span class="p">())</span>

    <span class="c1"># conservatively assume 10% of tokens held outside vault are traded</span>
    <span class="n">held_tokens</span> <span class="o">=</span> <span class="n">lp1_state</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">(</span><span class="s1">&#39;Held&#39;</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">held_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">tradable_itkn1_amt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">held_tokens</span>
        <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">tkn2</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">tradable_itkn1_amt</span><span class="p">))</span>
        <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">tradable_itkn1_amt</span><span class="p">)</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># ******* Data Capture ********</span>
    <span class="c1"># *****************************</span>

    <span class="c1"># price</span>
    <span class="n">pTKN_DAI_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LPQuote</span><span class="p">()</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">))</span>
    <span class="n">pTKN_iTKN_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LPQuote</span><span class="p">()</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">))</span>


    <span class="c1"># investment performance</span>
    <span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>
    <span class="n">itkn_redeem_child</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">lp1_invest_track</span><span class="p">)</span>
    <span class="n">tkn_redeem_tree</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">itkn_redeem_child</span><span class="p">)</span>

    <span class="n">lp_direct_invest_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tkn_redeem_parent</span><span class="p">)</span>
    <span class="n">lp1_direct_invest_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LPQuote</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">lp1_invest_track</span><span class="p">))</span>
    <span class="n">lp1_tree_invest_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tkn_redeem_tree</span><span class="p">)</span>

    <span class="c1"># DEX Fees</span>
    <span class="n">fee_lp_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TreeAmountQuote</span><span class="p">()</span><span class="o">.</span><span class="n">get_tot_y</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_fee</span><span class="p">(</span><span class="n">tkn1</span><span class="p">),</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_fee</span><span class="p">(</span><span class="n">dai1</span><span class="p">)))</span>
    <span class="n">fee_lp1_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TreeAmountQuote</span><span class="p">()</span><span class="o">.</span><span class="n">get_tot_y</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">lp1</span><span class="o">.</span><span class="n">get_fee</span><span class="p">(</span><span class="n">tkn2</span><span class="p">),</span> <span class="n">lp1</span><span class="o">.</span><span class="n">get_fee</span><span class="p">(</span><span class="n">itkn1</span><span class="p">)))</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">lp1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Redeem from parent</span>
<span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>

<span class="c1"># Redeem from tree (child + parent)</span>
<span class="n">itkn_redeem_child</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp1</span><span class="p">,</span> <span class="n">itkn1</span><span class="p">,</span> <span class="n">lp1_invest_track</span><span class="p">)</span>
<span class="n">tkn_redeem_tree</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">itkn_redeem_child</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_parent</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP tokens if </span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC pulled from parent (lp)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_tree</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp1_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP1 tokens if </span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC pulled from tree (lp + lp1)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 168992.23336796605, USDT = 173213.2595403727
Liquidity: 162988.06243043763

Exchange USDC-iUSDC (LP1)
Reserves: USDC = 28358.764821080924, iUSDC = 14178.452311854142
Liquidity: 16888.99236775931

103.318 USDC redeemed from 49.906 LP tokens if 100.0 invested USDC pulled from parent (lp)
123.625 USDC redeemed from 35.657 LP1 tokens if 100.0 invested USDC pulled from tree (lp + lp1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lp1_state</span><span class="o">.</span><span class="n">check_states</span><span class="p">()</span>
<span class="n">lp1_state</span><span class="o">.</span><span class="n">inspect_states</span><span class="p">(</span><span class="n">tail</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">num_states</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Amount of tokens retained across states: <span class="ansi-green-intense-fg ansi-bold">PASS</span>
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mint</th>
      <th>Held</th>
      <th>Vault</th>
      <th>Burned</th>
      <th>dHeld</th>
      <th>dVault</th>
      <th>dBurned</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1996</th>
      <td>98.510225</td>
      <td>5115.477353</td>
      <td>15320.132698</td>
      <td>79706.098972</td>
      <td>865.231166</td>
      <td>-903.574374</td>
      <td>39.660717</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>133.022023</td>
      <td>4190.558625</td>
      <td>16318.433501</td>
      <td>79731.227122</td>
      <td>-924.918728</td>
      <td>998.300803</td>
      <td>25.128150</td>
    </tr>
    <tr>
      <th>1998</th>
      <td>23.621715</td>
      <td>5269.652077</td>
      <td>15329.101526</td>
      <td>79774.487668</td>
      <td>1079.093452</td>
      <td>-989.331975</td>
      <td>43.260546</td>
    </tr>
    <tr>
      <th>1999</th>
      <td>33.379226</td>
      <td>3996.942272</td>
      <td>16601.570128</td>
      <td>79798.350586</td>
      <td>-1272.709805</td>
      <td>1272.468602</td>
      <td>23.862918</td>
    </tr>
    <tr>
      <th>2000</th>
      <td>63.680746</td>
      <td>5018.481752</td>
      <td>15445.601470</td>
      <td>79966.158991</td>
      <td>1021.539480</td>
      <td>-1155.968659</td>
      <td>167.808404</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">TKN_ax</span><span class="p">,</span> <span class="n">DAI_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">strt_pt</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">TKN_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">p_arr</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1"> Price (Market)&#39;</span><span class="p">)</span>
<span class="n">TKN_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">pTKN_DAI_arr</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">usd_nm</span><span class="si">}</span><span class="s1"> (LP)&#39;</span><span class="p">)</span>

<span class="n">TKN_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Price comparison: parent vs child LPs&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">TKN_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (USD)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">TKN_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">TKN_ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">DAI_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">pTKN_iTKN_arr</span><span class="p">[</span><span class="n">strt_pt</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">itkn_nm</span><span class="si">}</span><span class="s1"> (LP1)&#39;</span><span class="p">)</span>
<span class="n">DAI_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;prices&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">DAI_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (USD)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">DAI_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">DAI_ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_simple_tree_pt2_16_0.png" src="../_images/tutorials_simple_tree_pt2_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y1_samp</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">pTKN_DAI_arr</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>
             <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">},</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">pTKN_iTKN_arr</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>
             <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">},</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution: </span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">usd_nm</span><span class="si">}</span><span class="s1"> LP price (parent)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution: </span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">itkn_nm</span><span class="si">}</span><span class="s1"> LP1 price (child)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Frequency&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_simple_tree_pt2_17_1.png" src="../_images/tutorials_simple_tree_pt2_17_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lowess</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">lowess</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_sim_runs</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">(</span><span class="n">lp_direct_invest_arr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">15</span><span class="p">);</span> <span class="n">sm_lp_direct</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">(</span><span class="n">lp1_direct_invest_arr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">15</span><span class="p">);</span> <span class="n">sm_lp1_direct</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">(</span><span class="n">lp1_tree_invest_arr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">15</span><span class="p">);</span> <span class="n">sm_lp1_tree</span><span class="o">=</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">strt_ind</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">p_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Simple Tree (USDC / USDT) performance &#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">lp_direct_invest_arr</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">sm_lp_direct</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected return from parent (LP)&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">lp1_direct_invest_arr</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">sm_lp1_direct</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected return from child (LP1)&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">lp1_tree_invest_arr</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">sm_lp1_tree</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected return from tree (LP+LP1)&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$100 USD Investment&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;$100 USD Investment&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_simple_tree_pt2_18_1.png" src="../_images/tutorials_simple_tree_pt2_18_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN before is worth </span><span class="si">{</span><span class="n">sm_lp_direct</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN after direct investment into parent (lp)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN before is worth </span><span class="si">{</span><span class="n">sm_lp1_direct</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN after direct investment into child (lp1)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_invest</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN before is worth </span><span class="si">{</span><span class="n">sm_lp1_tree</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> TKN after investment into simple tree (lp + lp1)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
100.000 TKN before is worth 103.980 TKN after direct investment into parent (lp)
100.000 TKN before is worth 119.578 TKN after direct investment into child (lp1)
100.000 TKN before is worth 124.271 TKN after investment into simple tree (lp + lp1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fee_lp_arr</span><span class="p">))</span>

<span class="n">fee_lpB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fee_lp1_arr</span><span class="p">)</span>
<span class="n">fee_lpA</span> <span class="o">=</span> <span class="n">fee_lpB</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fee_lp_arr</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">fee_lpA</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Parent LP (</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">usd_nm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">fee_lpB</span><span class="p">,</span> <span class="n">fee_lpA</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">fee_lpB</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Child LP1 (</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">itkn_nm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fee_lp_arr</span><span class="p">)),</span> <span class="n">fee_lpB</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Arbitrage Fees (Direct Investment, Simple Tree, Uni V2)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time unit&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Collected Fees (USD)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x17fe16a10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_simple_tree_pt2_20_1.png" src="../_images/tutorials_simple_tree_pt2_20_1.png" />
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="simple_tree_pt1.html" class="btn btn-neutral float-left" title="Simple Uni V2 Tree (Part 1)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../onchain/price_threshold_swap.html" class="btn btn-neutral float-right" title="Price Agent" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Read the Docs core team.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>