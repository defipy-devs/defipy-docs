<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Uniswap Swap-Deposit &mdash; Docs  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Uniswap Withdraw-Swap" href="withdraw_swap.html" />
    <link rel="prev" title="Basic Constant Product" href="uniswap_test.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #673147" >
            <a href="../../index.html">
            <img src="../../_static/defipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Uniswap</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="uniswap_test.html">Basic Constant Product</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Uniswap Swap-Deposit</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#SwapDeposit-(incl.-fee)">SwapDeposit (incl. fee)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Solve-Problem">Solve Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Final-Steps">Final Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Final-Check">Final Check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="withdraw_swap.html">Uniswap Withdraw-Swap</a></li>
<li class="toctree-l2"><a class="reference internal" href="indexing_problem.html">Uniswap Indexing Problem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/balancer_test.html">Balancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/stableswap_test.html">Stableswap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analytics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/uniswap_simulation.html">Basic Uniswap Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Primitive API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../uniswapv2.html">Uniswap V2 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uniswapv3.html">Uniswap V3 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../balancer.html">Balancer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stableswap.html">StableSwap API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #673147" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Uniswap</a> &raquo;</li>
      <li>Uniswap Swap-Deposit</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/uniswap/tutorials/swap_deposit.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Uniswap-Swap-Deposit">
<h1>Uniswap Swap-Deposit<a class="headerlink" href="#Uniswap-Swap-Deposit" title="Permalink to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uniswappy.cpt.factory</span> <span class="kn">import</span> <span class="n">UniswapFactory</span>
<span class="kn">from</span> <span class="nn">uniswappy.erc</span> <span class="kn">import</span> <span class="n">ERC20</span>
<span class="kn">from</span> <span class="nn">uniswappy.process.deposit</span> <span class="kn">import</span> <span class="n">SwapDeposit</span>
<span class="kn">from</span> <span class="nn">uniswappy.process.swap</span> <span class="kn">import</span> <span class="n">WithdrawSwap</span>
<span class="kn">from</span> <span class="nn">uniswappy.process.liquidity</span> <span class="kn">import</span> <span class="n">RemoveLiquidity</span>
<span class="kn">from</span> <span class="nn">uniswappy.process.liquidity</span> <span class="kn">import</span> <span class="n">AddLiquidity</span>
<span class="kn">from</span> <span class="nn">uniswappy.process.swap</span> <span class="kn">import</span> <span class="n">Swap</span>
<span class="kn">from</span> <span class="nn">uniswappy.cpt.quote</span> <span class="kn">import</span> <span class="n">LPQuote</span>
<span class="kn">from</span> <span class="nn">uniswappy.utils.data</span> <span class="kn">import</span> <span class="n">UniswapExchangeData</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_nm</span> <span class="o">=</span> <span class="s1">&#39;user0&#39;</span>
<span class="n">eth_amount</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">usdc_amount</span> <span class="o">=</span> <span class="mi">1000000</span>
</pre></div>
</div>
</div>
<section id="SwapDeposit-(incl.-fee)">
<h2>SwapDeposit (incl. fee)<a class="headerlink" href="#SwapDeposit-(incl.-fee)" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">SwapDeposit</span></code> is where a certain amount of a specific token is deposited into the LP under one operation</p></li>
<li><p>Includes two steps:</p>
<ul>
<li><p>(step 1) perform approx. 50% swap for opposing token</p></li>
<li><p>(step 2) using amt from step 1, perform 1:1 deposit</p></li>
</ul>
</li>
<li><p>A portion of the incoming funds are swapped to achieve equal portions of both assets</p></li>
<li><p>These portions are then deposited into the LP</p></li>
<li><p>To ensure all the funds are deposited, we must determine the portion (<span class="math notranslate nohighlight">\(\alpha\)</span>) of <span class="math notranslate nohighlight">\(s_{in}\)</span> that must first get swapped</p></li>
</ul>
<p><span class="math">\begin{equation}
\Delta x = \Delta x_{swap}  + \Delta x_{deposit}
\end{equation}</span></p>
<p><span class="math">\begin{equation}
\Delta x = \alpha \Delta x   + \Delta x_{deposit}
\end{equation}</span></p>
<p>Follows this system of equations:</p>
<p><span class="math">\begin{equation}
\Delta y = \frac{997 y \alpha \Delta x }{1000x + 997\alpha\Delta x }
\tag{Eq. 1}
\end{equation}</span></p>
<p><span class="math">\begin{equation}
\Delta x = \alpha\Delta x   + \frac{\Delta y(x + \alpha\Delta x )}{y - \Delta y}
\tag{Eq. 2}
\end{equation}</span></p>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta x\)</span> -&gt; amt token in</p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta y\)</span> -&gt; amt opposing token out after swap</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha\)</span> -&gt; portion of <span class="math notranslate nohighlight">\(\Delta x\)</span> swapped in</p></li>
<li><p>x -&gt; reserve0</p></li>
<li><p>y -&gt; reserve1</p></li>
</ul>
<p>Let’s highlight why the above considerations are important …</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eth</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">usdc</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">eth</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">usdc</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="s2">&quot;ETH pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">Initial LP</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">s_in</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">s_out</span> <span class="o">=</span> <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">eth</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">LP post step 1</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">balance0</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span>
<span class="n">balance1</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">balance0</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">,</span> <span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">LP post step 2</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given </span><span class="si">{}</span><span class="s1"> initial ETH:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_in</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  (step 1) </span><span class="si">{}</span><span class="s1"> ETH must first get swapped for </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">,</span> <span class="n">s_out</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  (step 2) The received TKN gets deposited along with the remaining </span><span class="si">{}</span><span class="s1"> ETH&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">balance0</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total deposited is </span><span class="si">{:.6f}</span><span class="s1"> + </span><span class="si">{:.6f}</span><span class="s1"> = </span><span class="si">{:.6f}</span><span class="s1"> ETH:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">,</span>  <span class="n">balance0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span> <span class="o">+</span> <span class="n">balance0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;However, we have </span><span class="si">{}</span><span class="s1"> unaccounted USDC which need to be considered when using a 50/50 split&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">usdc_amount</span><span class="o">-</span><span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bold&#39;</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***
Initial LP
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1000, USDC = 1000000
Liquidity: 31622.776601683792

***
LP post step 1
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1050.0, USDC = 952517.026241844
Liquidity: 31622.776601683792

***
LP post step 2
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1100.0, USDC = 997874.9798724081
Liquidity: 33128.623106525876

Given 100 initial ETH:
  (step 1) 50.0 ETH must first get swapped for 47482.973758155924
  (step 2) The received TKN gets deposited along with the remaining 50.0 ETH

Total deposited is 50.000000 + 50.000000 = 100.000000 ETH:
However, we have <span class="ansi-red-intense-fg ansi-bold">2125.02012759191</span> unaccounted USDC which need to be considered when using a 50/50 split
</pre></div></div>
</div>
</section>
<section id="Solve-Problem">
<h2>Solve Problem<a class="headerlink" href="#Solve-Problem" title="Permalink to this heading"></a></h2>
<p>Let’s now address this problem …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usdc</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;TKN&quot;</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">eth</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">eth</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">usdc</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="s2">&quot;ETH pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">)</span>

<span class="n">s_in</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span>
</pre></div>
</div>
</div>
<p>Plug above into equation (1), and see how many TKN we get when 50% of ETH is swapped in for step (1)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">997</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">997</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For </span><span class="si">{}</span><span class="s1"> ETH, we get </span><span class="si">{:.2f}</span><span class="s1"> TKN with a 50% portion&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_in</span><span class="p">,</span> <span class="n">s_out</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
For 100 ETH, we get 47482.97 TKN with a 50% portion
</pre></div></div>
</div>
<p>Now, lets check how many ETH gets SwapDeposited in when 50% of ETH is swapped in for step (1)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1_out</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span> <span class="o">+</span> <span class="n">s_out</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">s_out</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Instead of </span><span class="si">{}</span><span class="s1"> ETH, we get </span><span class="si">{:.2f}</span><span class="s1"> ETH under a 50% portion&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_in</span><span class="p">,</span> <span class="n">a1_out</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Instead of 100 ETH, we get 102.34 ETH under a 50% portion
</pre></div></div>
</div>
<p>We can see that there is an imbalance in the system under a 50% distribution for step (1); * we need to solve the system above for <span class="math notranslate nohighlight">\(\alpha\)</span> to get the proper distribution * plug (1) into (2) and we get:</p>
<p><span class="math">\begin{equation}
\Delta x = \alpha\Delta x + \left(\frac{997 y\alpha\Delta x}{1000x + 997\alpha\Delta x} \right) \left(\frac{ x + \alpha\Delta x}{y - \frac{997 y \alpha \Delta x}{1000x + 997\alpha\Delta x}} \right)
\end{equation}</span></p>
<p>reduces to:</p>
<p><span class="math">\begin{equation}
\alpha^2 \frac{997 \Delta x^2}{1000x} + \alpha\frac{1997\Delta x}{1000} - \Delta x = 0
\end{equation}</span></p>
<p>Now, solve for, and we can calculate the correct distribution using calc_deposit_dist</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_deposit_portion</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>

    <span class="k">if</span><span class="p">(</span><span class="n">token_in</span><span class="o">.</span><span class="n">token_name</span> <span class="o">==</span> <span class="n">lp</span><span class="o">.</span><span class="n">token0</span><span class="p">):</span>
        <span class="n">tkn_supply</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tkn_supply</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mi">997</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">tkn_supply</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="mi">1997</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alpha</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="n">calc_deposit_portion</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">eth</span><span class="p">,</span> <span class="n">s_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The correct swap distrbution (for step 1) is </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The correct swap distrbution (for step 1) is 0.4888217399419355
</pre></div></div>
</div>
<p>Now, check against our reduced quadratic, and we should expect to get 0</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">997</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">s_in</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="o">*</span><span class="p">(</span><span class="mi">1997</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="n">s_in</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-5.684341886080802e-14
</pre></div></div>
</div>
</section>
<section id="Final-Steps">
<h2>Final Steps<a class="headerlink" href="#Final-Steps" title="Permalink to this heading"></a></h2>
<p>Finally, lets run through the steps to a <code class="docutils literal notranslate"><span class="pre">SwapDeposit</span></code> and compare above</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usdc</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">eth</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">eth</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">usdc</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="s2">&quot;ETH pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">Initial LP</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">s_in</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">calc_deposit_portion</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">eth</span><span class="p">,</span> <span class="n">s_in</span><span class="p">)</span>
<span class="n">s_out</span> <span class="o">=</span> <span class="n">Swap</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">eth</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">LP post step 1</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">balance1</span> <span class="o">=</span> <span class="n">s_out</span>
<span class="n">balance0</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">s_out</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">,</span> <span class="n">balance0</span><span class="p">,</span> <span class="n">balance1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***</span><span class="se">\n</span><span class="s1">LP post step 2</span><span class="se">\n</span><span class="s1">***&#39;</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given </span><span class="si">{}</span><span class="s1"> initial ETH:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_in</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  (step 1) </span><span class="si">{}</span><span class="s1"> ETH must first get swapped for </span><span class="si">{}</span><span class="s1"> USDC&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">,</span> <span class="n">s_out</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  (step 2) The received USDC gets deposited along with the remaining </span><span class="si">{}</span><span class="s1"> ETH&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">balance0</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Total deposited is </span><span class="si">{:.6f}</span><span class="s1"> + </span><span class="si">{:.6f}</span><span class="s1"> = </span><span class="si">{:.6f}</span><span class="s1"> ETH:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span><span class="p">,</span>  <span class="n">balance0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">*</span><span class="n">s_in</span> <span class="o">+</span> <span class="n">balance0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***
Initial LP
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1000, USDC = 1000000
Liquidity: 31622.776601683792

***
LP post step 1
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1048.8821739941936, USDC = 953529.2490856305
Liquidity: 31622.776601683792

***
LP post step 2
***
Exchange ETH-USDC (LP)
Reserves: ETH = 1100.0, USDC = 1000000.0
Liquidity: 33163.92929950274

Given 100 initial ETH:
  (step 1) 48.88217399419355 ETH must first get swapped for 46470.75091436944 USDC
  (step 2) The received USDC gets deposited along with the remaining 51.117826005806386 ETH

Total deposited is 48.882174 + 51.117826 = 100.000000 ETH:
</pre></div></div>
</div>
</section>
<section id="Final-Check">
<h2>Final Check<a class="headerlink" href="#Final-Check" title="Permalink to this heading"></a></h2>
<p>Finally, let’s check when our solution is integrated into <code class="docutils literal notranslate"><span class="pre">SwapDeposit</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">usdc</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">eth</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">eth</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">usdc</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="s2">&quot;ETH pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">add_liquidity</span><span class="p">(</span><span class="n">user_nm</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">,</span> <span class="n">eth_amount</span><span class="p">,</span> <span class="n">usdc_amount</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">s_in</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">dep</span> <span class="o">=</span> <span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">eth</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">s_in</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange ETH-USDC (LP)
Reserves: ETH = 1000, USDC = 1000000
Liquidity: 31622.776601683792

Exchange ETH-USDC (LP)
Reserves: ETH = 1100.0, USDC = 1000000.0
Liquidity: 33163.92929950274

</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="uniswap_test.html" class="btn btn-neutral float-left" title="Basic Constant Product" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="withdraw_swap.html" class="btn btn-neutral float-right" title="Uniswap Withdraw-Swap" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Read the Docs core team.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>