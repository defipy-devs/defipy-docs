<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onchain Analytics &mdash; DeFiPy  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Impermanent Loss" href="imp_loss.html" />
    <link rel="prev" title="Uniswap V3 Order Book" href="order_book.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #673147" >
            <a href="../index.html">
            <img src="../_static/defipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DeFi Math</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../math/univ2_math.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/univ3_math.html">Uniswap V3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../uniswapv2/index.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uniswapv3/index.html">Uniswap V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../balancer/index.html">Balancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stableswap/index.html">Stableswap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analytics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="univ2_sim.html">Uniswap V2 Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="order_book.html">Uniswap V3 Order Book</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Onchain Analytics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Overview:-ExecuteScript()">Overview: ExecuteScript()</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#üìò-defipy.utils.client.contract.ExecuteScript">üìò <code class="docutils literal notranslate"><span class="pre">defipy.utils.client.contract.ExecuteScript</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Methods"><strong>Methods</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Contract-paths">Contract paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Script-Functions">Script Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Simulate-price-data">Simulate price data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Pool-configuration">Pool configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Deploy-pool---Contracts">Deploy pool - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Retrieve-configurations---Contracts">Retrieve configurations - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Deploy-pool---Python">Deploy pool - Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Rebalance-pool---Python">Rebalance pool - Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Rebalance-pool---Contracts">Rebalance pool - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Investment-position---Contracts">Investment position - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Investment-position---Python">Investment position - Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Check-pool---Contracts">Check pool - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Begin-simulation">Begin simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plot-results">Plot results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Check pool - Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Check-pool---Python">Check pool - Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="imp_loss.html">Impermanent Loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="fsm.html">Finite State Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="simple_tree_pt1.html">Simple Uni V2 Tree (Part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="simple_tree_pt2.html">Simple Uni V2 Tree (Part 2)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Abstract API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../abstract_uniswap.html">Uniswap V2/V3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Primitive API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../primitive_uniswapv2.html">Uniswap V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_uniswapv3.html">Uniswap V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_balancer.html">Balancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primitive_stableswap.html">StableSwap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #673147" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DeFiPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Onchain Analytics</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/testnet_sim_univ2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Onchain-Analytics">
<h1>Onchain Analytics<a class="headerlink" href="#Onchain-Analytics" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>Here we utilize DeFiPy to drive onchain simulations on a local testnet using DeFiPy‚Äôs <code class="docutils literal notranslate"><span class="pre">Web3Scout</span></code> python package and DeFiPy‚Äôs <code class="docutils literal notranslate"><span class="pre">ExecuteScript()</span></code> class. If you are a Solidity developer and have a script setup that utilizes one of DeFiPy‚Äôs protocols, then this script should help get you started in keeping the heavier analytics offchain. There is no other DeFi tool of its kind that has this type of promise and capability.</p>
<p>We used <a class="reference external" href="https://getfoundry.sh/anvil/overview#anvil">Anvil</a> for our local testnet; to setup, for the installation docs for Foundry toolchain see <a class="reference external" href="https://getfoundry.sh/introduction/installation">here</a>. The example contracts that coincide with this notebook are not available yet and should be up soon; however if you need some guidance, please feel free to contact us at <a class="reference external" href="mailto:defipy&#46;devs&#37;&#52;&#48;gmail&#46;com">defipy<span>&#46;</span>devs<span>&#64;</span>gmail<span>&#46;</span>com</a>. Once the contracts are up, a more detailed tutorial should soon follow from this as well.</p>
<ul class="simple">
<li><p>Assumptions:</p>
<ul>
<li><p>Uses stablecoins (ie, USDC and USDT) to control for impermanent loss</p></li>
<li><p>Pre-minted supply of index tokens</p></li>
</ul>
</li>
<li><p>LPs include:</p>
<ul>
<li><p>USDC-USDT</p></li>
</ul>
</li>
</ul>
<section id="Overview:-ExecuteScript()">
<h2>Overview: ExecuteScript()<a class="headerlink" href="#Overview:-ExecuteScript()" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="üìò-defipy.utils.client.contract.ExecuteScript">
<h3>üìò <code class="docutils literal notranslate"><span class="pre">defipy.utils.client.contract.ExecuteScript</span></code><a class="headerlink" href="#üìò-defipy.utils.client.contract.ExecuteScript" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="line-block">
<div class="line"><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">defipy.utils.client.contract.ExecuteScript</span></code></div>
<div class="line"><strong>Purpose</strong>: A lightweight wrapper that exposes solidity script execution using the <a class="reference external" href="https://getfoundry.sh/forge/reference/overview/">Forge</a> shell command.</div>
</div>
</section>
<hr class="docutils" />
<section id="Methods">
<h3><strong>Methods</strong><a class="headerlink" href="#Methods" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">apply(script_path:</span> <span class="pre">str,</span> <span class="pre">rpc_url:</span> <span class="pre">str,</span> <span class="pre">args:</span> <span class="pre">list</span> <span class="pre">=</span> <span class="pre">[],</span> <span class="pre">verbose:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False,</span> <span class="pre">value:</span> <span class="pre">skip_sim</span> <span class="pre">=</span> <span class="pre">False)</span></code></div>
<div class="line">Executes on-chain solidty script as a Forge shell command</div>
</div>
<p><strong>Parameters</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">script_path</span></code>: path-to-solidity-script (<code class="docutils literal notranslate"><span class="pre">str</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rpc_url</span></code>: Ethereum address submitting the transaction (<code class="docutils literal notranslate"><span class="pre">str</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code>: Script arguments passed through run() (optional) (<code class="docutils literal notranslate"><span class="pre">int</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verbose</span></code>: Display print-out output from console (optional, default <code class="docutils literal notranslate"><span class="pre">False</span></code>) (<code class="docutils literal notranslate"><span class="pre">bool</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">skip_sim</span></code>: Skim simulation (optional, default <code class="docutils literal notranslate"><span class="pre">True</span></code>) (<code class="docutils literal notranslate"><span class="pre">bool</span></code>).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">defipy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">web3scout</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">base_dir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;defipy-docs/docs/tutorials&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Contract-paths">
<h2>Contract paths<a class="headerlink" href="#Contract-paths" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deploy_pool_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetDeployPool.s.sol&#39;</span>
<span class="n">check_amounts_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetCheckAmounts.s.sol&#39;</span>
<span class="n">invest_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetInvest.s.sol&#39;</span>
<span class="n">parent_arbitrage_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetArbitrage.s.sol&#39;</span>
<span class="n">swap_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetSwap.s.sol&#39;</span>
<span class="n">rebalance_path</span> <span class="o">=</span> <span class="s1">&#39;script/simulate_univ2/SimTestNetRebalance.s.sol&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="Script-Functions">
<h2>Script Functions<a class="headerlink" href="#Script-Functions" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rpc_url</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8545&#39;</span>
<span class="n">test_contract_dir</span> <span class="o">=</span> <span class="s1">&#39;/onchain-sim/&#39;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;/onchain-sim/test/output/&#39;</span>

<span class="n">exe</span> <span class="o">=</span>  <span class="n">ExecuteScript</span><span class="p">(</span><span class="n">base_dir</span><span class="o">+</span><span class="n">test_contract_dir</span><span class="p">)</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">UniswapScriptHelper</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Simulate-price-data">
<h2>Simulate price data<a class="headerlink" href="#Simulate-price-data" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tkn_nm</span> <span class="o">=</span> <span class="s1">&#39;USDC&#39;</span>
<span class="n">itkn_nm</span> <span class="o">=</span> <span class="s1">&#39;iUSDC&#39;</span>
<span class="n">usdt_nm</span> <span class="o">=</span> <span class="s1">&#39;USDT&#39;</span>
<span class="n">iusdt_nm</span> <span class="o">=</span> <span class="s1">&#39;iUSDT&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># *************************</span>
<span class="c1"># *** Simulation</span>
<span class="c1"># *************************</span>
<span class="n">n_sim_runs</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">seconds_year</span> <span class="o">=</span> <span class="mi">31536000</span>
<span class="n">shape</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mf">0.0005</span>

<span class="n">p_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">n_sim_runs</span><span class="p">)</span>

<span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_arr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds_year</span><span class="o">/</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="p">))</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2024-09-01&quot;</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">dt</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="p">)]</span>

<span class="n">x_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">p_arr</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">USD_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">p_arr</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial invest&#39;</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price Chart (</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">usdt_nm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (USD)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">USD_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;Date&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_testnet_sim_univ2_9_1.png" src="../_images/tutorials_testnet_sim_univ2_9_1.png" />
</div>
</div>
</section>
<section id="Pool-configuration">
<h2>Pool configuration<a class="headerlink" href="#Pool-configuration" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tkn0_amt_usd</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="n">invest_amt_usd</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">exe_contract</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">skip_sim</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">contract_time_lapse</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">tkn0_amt</span> <span class="o">=</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">dec2gwei</span><span class="p">(</span><span class="n">tkn0_amt_usd</span><span class="p">)</span>
<span class="n">tkn1_amt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">tkn0_amt</span><span class="p">)</span>
<span class="n">deploy_amt</span> <span class="o">=</span>  <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">dec2gwei</span><span class="p">(</span><span class="n">tkn0_amt_usd</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
<span class="n">mint_amt</span> <span class="o">=</span>  <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">dec2gwei</span><span class="p">(</span><span class="n">tkn0_amt_usd</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
<span class="n">invest_amt</span> <span class="o">=</span>  <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">dec2gwei</span><span class="p">(</span><span class="n">invest_amt_usd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mrk_cap</span> <span class="o">=</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">tkn0_amt</span><span class="p">)</span>
<span class="n">TKN_amt</span> <span class="o">=</span> <span class="n">TokenDeltaModel</span><span class="p">(</span><span class="mi">500000</span><span class="p">)</span> <span class="c1"># validated model</span>
<span class="n">swap_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">TKN_amt</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">swap_arr</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>
             <span class="n">hist_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">},</span> <span class="n">kde_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram: Unit Swap Volume (USD)&#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">swap_arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
70036.10239489403
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_testnet_sim_univ2_12_1.png" src="../_images/tutorials_testnet_sim_univ2_12_1.png" />
</div>
</div>
</section>
<section id="Deploy-pool---Contracts">
<h2>Deploy pool - Contracts<a class="headerlink" href="#Deploy-pool---Contracts" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deploy_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">tkn0_amt</span><span class="p">,</span> <span class="n">tkn1_amt</span><span class="p">,</span> <span class="n">deploy_amt</span><span class="p">,</span> <span class="n">mint_amt</span><span class="p">]</span>
<span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">deploy_pool_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">deploy_args</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No files changed, compilation skipped
EIP-3855 is not supported in one or more of the RPCs used.
Unsupported Chain IDs: 31337.
Contracts deployed with a Solidity version equal or higher than 0.8.20 might not work properly.
For more information, please see https://eips.ethereum.org/EIPS/eip-3855
Script ran successfully.

== Logs ==
  tkn0Amt = 1000000000000000000000000
  tkn1Amt = 1045066117085429422358528
  deployAmt = 200000000000000000000000
  token0Bal = 200000000000000000000000
  UniV2 totalSupply = 1022284753425105828208421
  UniV2 Actual totalSupply = 1022284753425105828208421
  UniV2 baseReserve0 = 1000000000000000000000000
  UniV2 baseReserve1 = 1045066117085429422358528

## Setting up 1 EVM.

==========================

Chain 31337

Estimated gas price: 0.000000017 gwei

Estimated total gas used for script: 22663731

Estimated amount required: 0.000000000385283427 ETH

==========================


==========================

ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.

Transactions saved to: /Users/ian_moore/repos/onchain-sim/broadcast/SimTestNetDeployPool.s.sol/31337/run-latest.json

Sensitive values saved to: /Users/ian_moore/repos/onchain-sim/cache_forge/SimTestNetDeployPool.s.sol/31337/run-latest.json

</pre></div></div>
</div>
</section>
<section id="Retrieve-configurations---Contracts">
<h2>Retrieve configurations - Contracts<a class="headerlink" href="#Retrieve-configurations---Contracts" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_net_addresses_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/ian_moore/repos/onchain-sim/script/deployments/SimTestNet-addresses.json&#39;</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_net_addresses_path</span><span class="p">)</span>
<span class="n">test_net_addresses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">univ2_pool_addr</span> <span class="o">=</span> <span class="n">test_net_addresses</span><span class="p">[</span><span class="s1">&#39;uniV2Pool&#39;</span><span class="p">]</span>
<span class="n">tkn0_addr</span> <span class="o">=</span> <span class="n">test_net_addresses</span><span class="p">[</span><span class="s1">&#39;tkn0&#39;</span><span class="p">]</span>
<span class="n">tkn1_addr</span> <span class="o">=</span> <span class="n">test_net_addresses</span><span class="p">[</span><span class="s1">&#39;tkn1&#39;</span><span class="p">]</span>
<span class="n">uniV2Factory_addr</span> <span class="o">=</span> <span class="n">test_net_addresses</span><span class="p">[</span><span class="s1">&#39;uniV2Factory&#39;</span><span class="p">]</span>

<span class="n">abi</span> <span class="o">=</span> <span class="n">ABILoad</span><span class="p">(</span><span class="n">Platform</span><span class="o">.</span><span class="n">SUSHI</span><span class="p">,</span> <span class="n">JSONContract</span><span class="o">.</span><span class="n">UniswapV2Pair</span><span class="p">)</span>
<span class="n">contract_interface</span> <span class="o">=</span> <span class="n">abi</span><span class="o">.</span><span class="n">get_abi_by_filename</span><span class="p">(</span><span class="n">abi</span><span class="o">.</span><span class="n">get_abi_path</span><span class="p">())</span>
<span class="n">connect</span> <span class="o">=</span> <span class="n">ConnectW3</span><span class="p">(</span><span class="n">Net</span><span class="o">.</span><span class="n">LOCALHOST</span><span class="p">)</span>
<span class="n">connect</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
<span class="n">w3</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">get_w3</span><span class="p">()</span>

<span class="n">univ2_pool_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">univ2_pool_addr</span><span class="p">),</span> <span class="n">abi</span><span class="o">=</span><span class="n">contract_interface</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">univ2_pool_contract</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">w3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">univ2_pool_addr</span><span class="p">),</span> <span class="n">abi</span><span class="o">=</span><span class="n">contract_interface</span><span class="p">[</span><span class="s1">&#39;abi&#39;</span><span class="p">])</span>
<span class="n">univ2_reserves</span> <span class="o">=</span> <span class="n">univ2_pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getReserves</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
<span class="n">lp_amt</span> <span class="o">=</span> <span class="n">univ2_pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">totalSupply</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Deploy-pool---Python">
<h2>Deploy pool - Python<a class="headerlink" href="#Deploy-pool---Python" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_nm</span> <span class="o">=</span> <span class="s1">&#39;user_machine_check&#39;</span>
<span class="n">token0Addr</span> <span class="o">=</span> <span class="s1">&#39;0x01&#39;</span>
<span class="n">token1Addr</span> <span class="o">=</span> <span class="s1">&#39;0x02&#39;</span>
<span class="n">basePoolAddr</span> <span class="o">=</span> <span class="s1">&#39;0x05&#39;</span>

<span class="n">tkn_nm</span> <span class="o">=</span> <span class="s1">&#39;USDC&#39;</span>
<span class="n">usdt_nm</span> <span class="o">=</span> <span class="s1">&#39;USDT&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">univ2_res0</span><span class="p">,</span> <span class="n">univ2_res1</span><span class="p">,</span> <span class="n">lp_amt</span><span class="p">)</span> <span class="o">=</span> <span class="n">UniswapScriptHelper</span><span class="p">()</span><span class="o">.</span><span class="n">pool_state</span><span class="p">(</span><span class="n">univ2_pool_contract</span><span class="p">)</span>

<span class="n">tkn1</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">tkn_nm</span><span class="p">,</span> <span class="s2">&quot;0x09&quot;</span><span class="p">)</span>
<span class="n">usdt1</span> <span class="o">=</span> <span class="n">ERC20</span><span class="p">(</span><span class="n">usdt_nm</span><span class="p">,</span> <span class="s2">&quot;0x111&quot;</span><span class="p">)</span>
<span class="n">exchg_data</span> <span class="o">=</span> <span class="n">UniswapExchangeData</span><span class="p">(</span><span class="n">tkn0</span> <span class="o">=</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">tkn1</span> <span class="o">=</span> <span class="n">usdt1</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;LP&quot;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;0x011&quot;</span><span class="p">)</span>

<span class="n">iVault1</span> <span class="o">=</span> <span class="n">IndexVault</span><span class="p">(</span><span class="s1">&#39;iVault1&#39;</span><span class="p">,</span> <span class="s2">&quot;0x7&quot;</span><span class="p">)</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">UniswapFactory</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tkn_nm</span><span class="si">}</span><span class="s2"> pool factory&quot;</span><span class="p">,</span> <span class="s2">&quot;0x2&quot;</span><span class="p">)</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">exchg_data</span><span class="p">)</span>
<span class="n">Join</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">univ2_res0</span><span class="p">),</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">univ2_res1</span><span class="p">))</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 1000000.0, USDT = 1045066.1170854294
Liquidity: 1022284.7534251058

</pre></div></div>
</div>
</section>
<section id="Rebalance-pool---Python">
<h2>Rebalance pool - Python<a class="headerlink" href="#Rebalance-pool---Python" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-balance LP price</span>
<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">usdt1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">tkn1</span><span class="p">)):</span>
    <span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">usdt1</span><span class="p">)</span> <span class="o">-</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">tkn1</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">usdt1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">tkn1</span><span class="p">)</span> <span class="o">-</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_reserve</span><span class="p">(</span><span class="n">usdt1</span><span class="p">))</span>

<span class="n">sDel_base</span> <span class="o">=</span> <span class="n">SolveDeltas</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 1045066.1170854294, USDT = 1045066.1170854294
Liquidity: 1045031.8942643927

</pre></div></div>
</div>
</section>
<section id="Rebalance-pool---Contracts">
<h2>Rebalance pool - Contracts<a class="headerlink" href="#Rebalance-pool---Contracts" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rebalance_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No files changed, compilation skipped
EIP-3855 is not supported in one or more of the RPCs used.
Unsupported Chain IDs: 31337.
Contracts deployed with a Solidity version equal or higher than 0.8.20 might not work properly.
For more information, please see https://eips.ethereum.org/EIPS/eip-3855
Script ran successfully.

== Logs ==
  uniV2PoolAddr = 0x3d3747533A5df8964B53834D2036Cc8308158aBF
  iUniV2PoolAddr = 0xF5B6F5b75E92Ed849DC99f8536a1c71fC66087e6
  tkn0Addr = 0x711Db28ac813ec9565A06a2833f75dc28Eda3e12
  tkn1Addr = 0xd23DcA952d09cA82220De789A11F6a70C9250ca7
  proceedsAmount = 22747885765192267375701
  UniV2 totalSupply = 1045031894264392662958719
  UniV2 baseReserve0 = 1045066117085429422358528
  UniV2 baseReserve1 = 1045066117085429422358528

## Setting up 1 EVM.

==========================

Chain 31337

Estimated gas price: 0.000000017 gwei

Estimated total gas used for script: 414938

Estimated amount required: 0.000000000007053946 ETH

==========================


==========================

ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.

Transactions saved to: /Users/ian_moore/repos/onchain-sim/broadcast/SimTestNetRebalance.s.sol/31337/run-latest.json

Sensitive values saved to: /Users/ian_moore/repos/onchain-sim/cache_forge/SimTestNetRebalance.s.sol/31337/run-latest.json

</pre></div></div>
</div>
</section>
<section id="Investment-position---Contracts">
<h2>Investment position - Contracts<a class="headerlink" href="#Investment-position---Contracts" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invest_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">invest_amt</span><span class="p">]</span>
<span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">invest_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">invest_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;/onchain-sim/script/deployments/&#39;</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;SimTestNet-investment.json&#39;</span>
<span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">output_dir</span><span class="o">+</span><span class="n">output_file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">contract_output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">lp1_invest_track_contract</span> <span class="o">=</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">contract_output</span><span class="p">[</span><span class="s1">&#39;yieldOut&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No files changed, compilation skipped
EIP-3855 is not supported in one or more of the RPCs used.
Unsupported Chain IDs: 31337.
Contracts deployed with a Solidity version equal or higher than 0.8.20 might not work properly.
For more information, please see https://eips.ethereum.org/EIPS/eip-3855
Script ran successfully.

== Logs ==
  uniV2PoolAddr = 0x3d3747533A5df8964B53834D2036Cc8308158aBF
  iUniV2PoolAddr = 0xF5B6F5b75E92Ed849DC99f8536a1c71fC66087e6
  tkn0Addr = 0x711Db28ac813ec9565A06a2833f75dc28Eda3e12
  tkn1Addr = 0xd23DcA952d09cA82220De789A11F6a70C9250ca7
  devs = 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
  proceedsAmount = 49921308307938592016
  UniV2 totalSupply = 1045081816322630627706931
  UniV2 totalSupply = 1045081816322630627706931
  UniV2 baseReserve0 = 1045066117085429422358528
  UniV2 baseReserve1 = 1045166117085429422358528
  yieldOut = 49922058237964748212
  yieldOut = 49922058237964748212

## Setting up 1 EVM.

==========================

Chain 31337

Estimated gas price: 0.000000017 gwei

Estimated total gas used for script: 405466

Estimated amount required: 0.000000000006892922 ETH

==========================


==========================

ONCHAIN EXECUTION COMPLETE &amp; SUCCESSFUL.

Transactions saved to: /Users/ian_moore/repos/onchain-sim/broadcast/SimTestNetInvest.s.sol/31337/run-latest.json

Sensitive values saved to: /Users/ian_moore/repos/onchain-sim/cache_forge/SimTestNetInvest.s.sol/31337/run-latest.json

</pre></div></div>
</div>
</section>
<section id="Investment-position---Python">
<h2>Investment position - Python<a class="headerlink" href="#Investment-position---Python" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invested_user_nm</span> <span class="o">=</span> <span class="s1">&#39;invested_user&#39;</span>
<span class="n">tkn_invest_amt</span> <span class="o">=</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">invest_amt</span><span class="p">)</span>

<span class="n">SwapDeposit</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">invested_user_nm</span><span class="p">,</span> <span class="n">tkn_invest_amt</span><span class="p">)</span>
<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">lp_invest_track</span>  <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_liquidity_from_provider</span><span class="p">(</span><span class="n">invested_user_nm</span><span class="p">)</span>
<span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_parent</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP tokens if </span><span class="si">{</span><span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">invest_amt</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC immediately pulled from parent&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 1045166.1170854294, USDT = 1045066.1170854294
Liquidity: 1045081.8163226306

99.700 USDC redeemed from 49.922 LP tokens if 100.0 invested USDC immediately pulled from parent
</pre></div></div>
</div>
</section>
<section id="Check-pool---Contracts">
<h2>Check pool - Contracts<a class="headerlink" href="#Check-pool---Contracts" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">check_amounts_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No files changed, compilation skipped
Script ran successfully.

== Logs ==
  uniV2PoolAddr = 0x3d3747533A5df8964B53834D2036Cc8308158aBF
  iUniV2PoolAddr = 0xF5B6F5b75E92Ed849DC99f8536a1c71fC66087e6
  tkn0Addr = 0x711Db28ac813ec9565A06a2833f75dc28Eda3e12
  tkn1Addr = 0xd23DcA952d09cA82220De789A11F6a70C9250ca7
  UniV2 totalSupply = 1045081816322630627706931
  UniV2 totalSupply = 1045081816322630627706931
  UniV2 baseReserve0 = 1045066117085429422358528
  UniV2 baseReserve1 = 1045166117085429422358528
</pre></div></div>
</div>
</section>
<section id="Begin-simulation">
<h2>Begin simulation<a class="headerlink" href="#Begin-simulation" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_sim_arr1</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">p_python_arr1</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">p_contract_arr1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">p_sim_arr2</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">p_python_arr2</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">p_contract_arr2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lp_direct_invest_arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lp1_direct_invest_arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lp1_tree_invest_arr</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Begin onchain simulation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="p">):</span>

    <span class="n">amt_swap</span> <span class="o">=</span> <span class="n">TKN_amt</span><span class="o">.</span><span class="n">delta</span><span class="p">()</span>

    <span class="c1"># ****************************************</span>
    <span class="c1"># ***** Calculate Arbitrage Amounts ******</span>
    <span class="c1"># ****************************************</span>
    <span class="n">p_sim1</span> <span class="o">=</span> <span class="n">p_arr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="p">(</span><span class="n">dep_tkn_x1</span><span class="p">,</span> <span class="n">dep_tkn_y1</span><span class="p">,</span> <span class="n">wd_tkn_x1</span><span class="p">,</span> <span class="n">wd_tkn_y1</span><span class="p">,</span> <span class="n">direction1</span><span class="p">)</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">calc_arb_contract</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">sDel_base</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">usdt1</span><span class="p">,</span> <span class="n">user_nm</span><span class="p">,</span> <span class="n">p_sim1</span><span class="p">)</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># **** Contract Arbitrage *****</span>
    <span class="c1"># *****************************</span>
    <span class="n">arb_args1</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_tkn_x1</span><span class="p">,</span> <span class="n">dep_tkn_y1</span><span class="p">,</span> <span class="n">wd_tkn_x1</span><span class="p">,</span> <span class="n">wd_tkn_y1</span><span class="p">,</span> <span class="n">direction1</span><span class="p">]</span>
    <span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parent_arbitrage_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">arb_args1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="n">skip_sim</span><span class="p">)</span>
    <span class="p">(</span><span class="n">univ2_res0</span><span class="p">,</span> <span class="n">univ2_res1</span><span class="p">,</span> <span class="n">lp_amt</span><span class="p">)</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">pool_state</span><span class="p">(</span><span class="n">univ2_pool_contract</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">price_tkn0_contract1</span> <span class="o">=</span> <span class="n">univ2_res1</span><span class="o">/</span><span class="n">univ2_res0</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">contract_time_lapse</span><span class="p">)</span>

    <span class="c1"># **************************************</span>
    <span class="c1"># ** Recalibrate Pool State - Python ***</span>
    <span class="c1"># **************************************</span>
    <span class="p">(</span><span class="n">univ2_res0</span><span class="p">,</span> <span class="n">univ2_res1</span><span class="p">,</span> <span class="n">lp_amt</span><span class="p">)</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">pool_state</span><span class="p">(</span><span class="n">univ2_pool_contract</span><span class="p">)</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span> <span class="o">=</span> <span class="n">univ2_res0</span><span class="p">;</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span> <span class="o">=</span> <span class="n">univ2_res1</span><span class="p">;</span> <span class="n">lp</span><span class="o">.</span><span class="n">total_supply</span> <span class="o">=</span> <span class="n">lp_amt</span>
    <span class="n">price_tkn0_python1</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">tkn1</span><span class="p">)</span>

    <span class="c1"># ************************************</span>
    <span class="c1"># ** Induce Trade Volume - Contract **</span>
    <span class="c1"># ************************************</span>
    <span class="n">arb_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">dec2gwei</span><span class="p">(</span><span class="n">amt_swap</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">swap_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">arb_args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="n">skip_sim</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">contract_time_lapse</span><span class="p">)</span>

    <span class="c1"># **************************************</span>
    <span class="c1"># ** Recalibrate Pool State - Python ***</span>
    <span class="c1"># **************************************</span>

    <span class="p">(</span><span class="n">univ2_res0</span><span class="p">,</span> <span class="n">univ2_res1</span><span class="p">,</span> <span class="n">lp_amt</span><span class="p">)</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">pool_state</span><span class="p">(</span><span class="n">univ2_pool_contract</span><span class="p">)</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">reserve0</span> <span class="o">=</span> <span class="n">univ2_res0</span><span class="p">;</span> <span class="n">lp</span><span class="o">.</span><span class="n">reserve1</span> <span class="o">=</span> <span class="n">univ2_res1</span><span class="p">;</span> <span class="n">lp</span><span class="o">.</span><span class="n">total_supply</span> <span class="o">=</span> <span class="n">lp_amt</span>

    <span class="c1"># # ***********************************</span>
    <span class="c1"># # *** Induce Trade Volume - Python **</span>
    <span class="c1"># # ***********************************</span>

    <span class="c1"># *****************************</span>
    <span class="c1"># ***** Data Collection *******</span>
    <span class="c1"># *****************************</span>
    <span class="n">p_sim_arr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_sim1</span><span class="p">)</span>
    <span class="n">p_python_arr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price_tkn0_python1</span><span class="p">)</span>
    <span class="n">p_contract_arr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price_tkn0_contract1</span><span class="p">)</span>

    <span class="c1"># investment performance</span>
    <span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>
    <span class="n">lp_direct_invest_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tkn_redeem_parent</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">n_sim_runs</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[UniV2: step </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">] Actual price </span><span class="si">{</span><span class="n">p_sim1</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1"> / Python price </span><span class="si">{</span><span class="n">price_tkn0_python1</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1"> / Contract price </span><span class="si">{</span><span class="n">price_tkn0_contract1</span><span class="si">:</span><span class="s1">.5f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">tkn_redeem_parent</span> <span class="o">=</span> <span class="n">LPQuote</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_amount_from_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tkn1</span><span class="p">,</span> <span class="n">lp_invest_track</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tkn_redeem_parent</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> USDC redeemed from </span><span class="si">{</span><span class="n">lp_invest_track</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> LP tokens if </span><span class="si">{</span><span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">invest_amt</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> invested USDC pulled from parent (lp)&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Begin onchain simulation

[UniV2: step 0] Actual price 1.04507 / Python price 1.04470 / Contract price 1.04470
[UniV2: step 10] Actual price 0.97128 / Python price 0.97160 / Contract price 0.97160
[UniV2: step 20] Actual price 0.98831 / Python price 0.98845 / Contract price 0.98845
[UniV2: step 30] Actual price 1.00647 / Python price 1.00583 / Contract price 1.00583
[UniV2: step 40] Actual price 1.02448 / Python price 1.02253 / Contract price 1.02253
[UniV2: step 50] Actual price 1.01762 / Python price 1.01572 / Contract price 1.01572
[UniV2: step 60] Actual price 0.99411 / Python price 0.99413 / Contract price 0.99413
[UniV2: step 70] Actual price 1.00409 / Python price 1.00408 / Contract price 1.00408
[UniV2: step 80] Actual price 0.99276 / Python price 0.99261 / Contract price 0.99261
[UniV2: step 90] Actual price 1.00629 / Python price 1.00306 / Contract price 1.00306
[UniV2: step 100] Actual price 0.98841 / Python price 0.98841 / Contract price 0.98841
[UniV2: step 110] Actual price 1.00042 / Python price 1.00051 / Contract price 1.00051
[UniV2: step 120] Actual price 1.00611 / Python price 1.00545 / Contract price 1.00545
[UniV2: step 130] Actual price 1.00932 / Python price 1.00909 / Contract price 1.00909
[UniV2: step 140] Actual price 0.97644 / Python price 0.97646 / Contract price 0.97646
[UniV2: step 150] Actual price 0.99565 / Python price 0.99576 / Contract price 0.99576
[UniV2: step 160] Actual price 1.01413 / Python price 1.01191 / Contract price 1.01191
[UniV2: step 170] Actual price 0.98983 / Python price 0.98974 / Contract price 0.98974
[UniV2: step 180] Actual price 1.00455 / Python price 1.00465 / Contract price 1.00465
[UniV2: step 190] Actual price 0.96916 / Python price 0.96908 / Contract price 0.96908
[UniV2: step 200] Actual price 0.99885 / Python price 0.99879 / Contract price 0.99879
[UniV2: step 210] Actual price 0.99900 / Python price 0.99832 / Contract price 0.99832
[UniV2: step 220] Actual price 1.02183 / Python price 1.02174 / Contract price 1.02174
[UniV2: step 230] Actual price 0.99879 / Python price 0.99880 / Contract price 0.99880
[UniV2: step 240] Actual price 0.99095 / Python price 0.99087 / Contract price 0.99087
Exchange USDC-USDT (LP)
Reserves: USDC = 1348658.970125745, USDT = 1384056.8170036108
Liquidity: 1276491.1613168009

105.329 USDC redeemed from 49.922 LP tokens if 100.0 invested USDC pulled from parent (lp)
</pre></div></div>
</div>
</section>
<section id="Plot-results">
<h2>Plot results<a class="headerlink" href="#Plot-results" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lp_direct_invest_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lp_direct_invest_arr</span><span class="p">)</span>

<span class="n">lowess</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">lowess</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_sim_runs</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">(</span><span class="n">lp_direct_invest_arr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">15</span><span class="p">);</span> <span class="n">sm_lp_direct</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">parent_return</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">sm_lp_direct</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">invest_amt_usd</span><span class="o">-</span><span class="mi">100</span>

<span class="n">strt_ind</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">p_ax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;On-chain performance of Stablecoin Pool (USDC / USDT) via simulation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:</span><span class="n">n_sim_runs</span><span class="p">],</span> <span class="n">lp_direct_invest_arr</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;UniV2 token&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:</span><span class="n">n_sim_runs</span><span class="p">],</span> <span class="n">sm_lp_direct</span><span class="p">[</span><span class="n">strt_ind</span><span class="p">:],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected return from pool (LP)&#39;</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;UniV2 LP token return: </span><span class="si">{</span><span class="n">parent_return</span><span class="si">:</span><span class="s1">.4</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">invest_amt</span><span class="p">)</span><span class="o">*</span><span class="mi">95</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="n">UniV3Helper</span><span class="p">()</span><span class="o">.</span><span class="n">gwei2dec</span><span class="p">(</span><span class="n">invest_amt</span><span class="p">)</span><span class="o">*</span><span class="mi">115</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$100 USD Investment&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">p_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x17687b520&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_testnet_sim_univ2_34_1.png" src="../_images/tutorials_testnet_sim_univ2_34_1.png" />
</div>
</div>
</section>
<section id="id1">
<h2>Check pool - Contracts<a class="headerlink" href="#id1" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="o">.</span><span class="n">pool_state</span><span class="p">(</span><span class="n">univ2_pool_contract</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TKN0 1348658.97 / TKN1 1384056.82 / Liquidity 1276491.16
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1348658970125745095980850,
 1384056817003610713496879,
 1276491161316800852556144)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">check_amounts_path</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No files changed, compilation skipped
Script ran successfully.

== Logs ==
  uniV2PoolAddr = 0x3d3747533A5df8964B53834D2036Cc8308158aBF
  iUniV2PoolAddr = 0xF5B6F5b75E92Ed849DC99f8536a1c71fC66087e6
  tkn0Addr = 0x711Db28ac813ec9565A06a2833f75dc28Eda3e12
  tkn1Addr = 0xd23DcA952d09cA82220De789A11F6a70C9250ca7
  UniV2 totalSupply = 1276491161316800852556144
  UniV2 totalSupply = 1276491161316800852556144
  UniV2 baseReserve0 = 1348658970125745095980850
  UniV2 baseReserve1 = 1384056817003610713496879
</pre></div></div>
</div>
</section>
<section id="Check-pool---Python">
<h2>Check pool - Python<a class="headerlink" href="#Check-pool---Python" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lp</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exchange USDC-USDT (LP)
Reserves: USDC = 1348658.970125745, USDT = 1384056.8170036108
Liquidity: 1276491.1613168009

</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="order_book.html" class="btn btn-neutral float-left" title="Uniswap V3 Order Book" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="imp_loss.html" class="btn btn-neutral float-right" title="Impermanent Loss" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Read the Docs core team.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>